#!/bin/sh
# ═══════════════════════════════════════════════════════
# Pre-commit hook for gswarm-api
# MINIMAL: Only checks .env encryption + data/ directory
# Linting/validation handled by VERIFY+FIX agents
# ═══════════════════════════════════════════════════════

# Check if .env is staged and unencrypted
if git diff --cached --name-only | grep -q "^\.env$"; then
  # Check for dotenvx encryption marker
  if ! grep -q "^#/-------------------\[DOTENV" .env 2>/dev/null; then
    echo "❌ ERROR: .env contains unencrypted secrets!"
    echo ""
    echo "   Run: pnpm env:encrypt"
    echo ""
    echo "   Then: git add .env"
    echo ""
    exit 1
  fi
  echo "✅ .env is encrypted"
fi

# Block commits of data/ directory (persistent state lives in Redis now)
if git diff --cached --name-only | grep -q "^data/"; then
  echo "❌ ERROR: Attempting to commit files from data/ directory!"
  echo ""
  echo "   The data/ directory contains runtime state (tokens, sessions, metrics)"
  echo "   and must NEVER be committed to git. All persistent state is stored in Redis."
  echo ""
  echo "   To unstage: git reset data/"
  echo ""
  exit 1
fi
