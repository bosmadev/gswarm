name: Build and Deploy to Azure VM (WSL)

on:
  push:
    branches: [main]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Read app metadata from package.json
        run: |
          APP_NAME=$(jq -r '.name' package.json)
          echo "APP_NAME=$APP_NAME" >> "$GITHUB_ENV"
          echo "DEPLOY_PATH=/opt/$APP_NAME" >> "$GITHUB_ENV"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Setup uv (Python package manager)
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build standalone
        env:
          DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}
        run: |
          pnpm build
          cp -r public .next/standalone/ 2>/dev/null || echo "[INFO] No public folder"
          cp -r .next/static .next/standalone/.next/
          # post-build.mjs does the rest.

      - name: Deploy to Azure VM (WSL)
        uses: Burnett01/rsync-deployments@v8
        with:
          switches: -avzr --delete --exclude=data/
          path: .next/standalone/
          remote_path: ${{ env.DEPLOY_PATH }}/
          remote_host: ${{ secrets.AZURE_VM_IP }}
          remote_user: ${{ secrets.AZURE_VM_USER }}
          remote_key: ${{ secrets.AZURE_SSH_PRIVATE_KEY }}

      - name: Setup service and restart
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AZURE_VM_IP }}
          username: ${{ secrets.AZURE_VM_USER }}
          key: ${{ secrets.AZURE_SSH_PRIVATE_KEY }}
          envs: APP_NAME,DEPLOY_PATH
          script: |
            # Create/overwrite service file (tee always overwrites)
            sudo tee /etc/systemd/system/${APP_NAME}.service > /dev/null << SERVICEFILE
            [Unit]
            Description=${APP_NAME}
            After=network.target

            [Service]
            Type=simple
            User=${APP_NAME}
            WorkingDirectory=${DEPLOY_PATH}
            Environment=NODE_ENV=production
            EnvironmentFile=-${DEPLOY_PATH}/.env
            ExecStart=/usr/bin/node server.js
            Restart=always
            RestartSec=5

            [Install]
            WantedBy=multi-user.target
            SERVICEFILE

            # Ensure service user exists
            id ${APP_NAME} &>/dev/null || sudo useradd --system --shell /usr/sbin/nologin ${APP_NAME}

            # Set permissions
            sudo chown -R ${APP_NAME}:${APP_NAME} ${DEPLOY_PATH}
            # Restrict .env file access (contains secrets)
            [ -f ${DEPLOY_PATH}/.env ] && sudo chmod 600 ${DEPLOY_PATH}/.env

            # Reload and restart (handles stop/start automatically)
            sudo systemctl daemon-reload
            sudo systemctl enable ${APP_NAME}
            sudo systemctl restart ${APP_NAME}

            # Verify service started
            sleep 2
            sudo systemctl status ${APP_NAME} --no-pager

            # Health check - verify HTTP response (dynamic port from .env)
            echo "Running health check..."
            # Read GLOBAL_PORT from .env (default to 3000 if not set)
            APP_PORT=$(grep -oP '^GLOBAL_PORT=\K\d+' ${DEPLOY_PATH}/.env 2>/dev/null || echo "3000")
            echo "Using port: $APP_PORT"
            for i in {1..5}; do
              if curl -sf "http://127.0.0.1:${APP_PORT}" > /dev/null 2>&1; then
                echo "Health check passed on attempt $i (port ${APP_PORT})"
                exit 0
              fi
              echo "Attempt $i failed, waiting..."
              sleep 2
            done
            echo "Health check failed after 5 attempts (port ${APP_PORT})"
            sudo journalctl -u ${APP_NAME} --no-pager -n 50
            exit 1
